{"posts":[{"title":"玩玩Prometheus的NodeExporter","content":"最近需要重写OracleExporter，研究研究NodeExporter的实现以寻找开发OracleExporter的最佳实践Prometheus的Collectorprometheus提供一个Collector接口，其包含两个方法typeCollectorinterface{Describe(chan&lt;-*Desc)Collect(chan&lt;-Metric)}Describe：Describe方法用来注册prometheus.Collector创建的指标。Collect：Collect方法用来执行采集任务，为指标赋值即可。构建Exporter时，创建prometheus.Collector的实例，调用这两个方法即可完成Exporter对target的采集。但如果把采集的逻辑全部都放在Collect方法里面，将导致采集逻辑大量堆砌，可读性将非常差，所以NodeExporter又定义了一个collector.Collector接口，将某一类的采集封装起来。那么此时，NodeExporter来说，它包含两个Collectorprometheus.Collectorcollector.Collector这两者都是用来做采集的，但是collector.Collector实例是真正执行采集指标的业务，而prometheus.Collector用来采集collector.Collector的采集信息，这句话听上去很绕，什么意思呢？NodeExporter的Describe中向prometheus传递了两个指标scrapeDuration:记录collector.Collector实例采集任务执行的时间scrapeSuccess:记录collector.Collector实例采集任务执行状态（成功或失败)根据指标的描述，这就很好理解“prometheus.Collector用来采集collector.Collector的采集信息”这句话的含义了。下面是其代码逻辑的实现prometheus.Collector.Collect其核心逻辑是为每个collector.Collector实例创建一个goroutine来收集监控指标//Collectimplementstheprometheus.Collectorinterface.func(nNodeCollector)Collect(chchan&lt;-prometheus.Metric){wg:=sync.WaitGroup{}wg.Add(len(n.Collectors))forname,c:=rangen.Collectors{//为每个Collector创建单独的goroutinegofunc(namestring,cCollector){execute(name,c,ch,n.logger)wg.Done()}(name,c)}//等待所有的collector.Collector采集完毕wg.Wait()}","link":"https://zhangfane.github.io/post/wan-wan-prometheus-de-nodeexporter/"}]}